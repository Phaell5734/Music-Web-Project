@model List<User>
@{
    ViewData["Title"] = "User Management";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <style>
        .user-management-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .user-list-frame {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: #fafafa;
            padding: 20px;
            min-height: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .user-list-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            background: #fff;
            transition: box-shadow 0.2s ease;
        }

            .user-list-item:hover {
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

            .user-list-item.banned {
                border-left: 4px solid #dc3545;
                background: #fff5f5;
            }

        .user-info-label {
            font-weight: 600;
            color: #666;
            font-size: 0.85rem;
            margin-bottom: 3px;
        }

        .user-info-value {
            font-size: 0.9rem;
            color: #333;
            margin-bottom: 10px;
        }

        .action-btn {
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .ban-btn {
            background: #dc3545;
        }

            .ban-btn:hover {
                background: #c82333;
            }

        .activate-btn {
            background: #28a745;
        }

            .activate-btn:hover {
                background: #218838;
            }

        .role-badge {
            font-size: 0.7rem;
            margin-right: 4px;
        }

        .subscription-badge {
            font-size: 0.75rem;
        }

        .status-badge {
            font-size: 0.75rem;
            font-weight: bold;
        }

        .status-active {
            background: #28a745;
        }

        .status-banned {
            background: #dc3545;
        }

        .balance-amount {
            font-weight: bold;
            color: #28a745;
        }

        .songs-count {
            font-weight: bold;
            color: #007bff;
        }

        .info-section {
            background: #fff;
            border: 2px solid #17a2b8;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

            .info-section h5 {
                color: #17a2b8;
                margin-bottom: 15px;
            }

            .info-section .alert {
                margin-bottom: 0;
            }

        .status-by-id-section {
            background: #fff;
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

            .status-by-id-section h5 {
                color: #ffc107;
                margin-bottom: 15px;
            }

        .form-control:focus {
            border-color: #ffc107;
            box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
        }

        .btn-outline-danger {
            border-color: #dc3545;
            color: #dc3545;
        }

            .btn-outline-danger:hover {
                background-color: #dc3545;
                border-color: #dc3545;
                color: #fff;
            }
    </style>
}

<div class="container-fluid py-4">
    <div class="user-management-container">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">User Management</h2>
            <a asp-action="Index" class="btn btn-secondary">
                <i class="fa fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>

        <!-- Info Section -->
        <div class="info-section">
            <h5><i class="fa fa-info-circle me-2"></i>User Management Information</h5>
            <div class="alert alert-info">
                <strong>Note:</strong> Users are managed through status changes rather than deletion.
                Use <strong>Ban</strong> to permanently disable users or <strong>Activate</strong> to restore access.
                Banned users cannot log in to the system and are automatically filtered from most system views.
            </div>
        </div>

        <!-- Change Status by User ID Section -->
        <div class="status-by-id-section">
            <h5><i class="fa fa-user-cog me-2"></i>Change User Status by ID</h5>
            <div class="row align-items-end">
                <div class="col-md-4">
                    <label for="userIdInput" class="form-label">User ID</label>
                    <input type="number" id="userIdInput" class="form-control"
                           placeholder="Enter User ID">
                </div>
                <div class="col-md-8">
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-danger" id="banByIdBtn">
                            <i class="fa fa-ban me-2"></i>Ban User
                        </button>
                        <button class="btn btn-outline-success" id="activateByIdBtn">
                            <i class="fa fa-check me-2"></i>Activate User
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users List Frame -->
        <div class="user-list-frame">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">All Users (@(Model?.Count ?? 0))</h4>
                <small class="text-muted">Scroll down to see more users</small>
            </div>

            @if (Model != null && Model.Any())
            {
                @foreach (var user in Model)
                {
                    <div class="user-list-item @(user.Status?.ToLower() == "banned" ? "banned" : "")">
                        <div class="row align-items-center">
                            <div class="col-md-10">
                                <div class="row">
                                    <div class="col-md-2">
                                        <div class="user-info-label">User ID</div>
                                        <div class="user-info-value"><strong>#@user.UserId</strong></div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="user-info-label">Username</div>
                                        <div class="user-info-value">@user.UserName</div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="user-info-label">Full Name</div>
                                        <div class="user-info-value">@user.FirstName @user.LastName</div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="user-info-label">Email</div>
                                        <div class="user-info-value">@user.Email</div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="user-info-label">Balance</div>
                                        <div class="user-info-value">
                                            <span class="balance-amount">$@((user.Balance ?? 0).ToString("F2"))</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="user-info-label">Status</div>
                                        <div class="user-info-value">
                                            <span class="badge status-badge status-@(user.Status?.ToLower() ?? "active")">
                                                @(user.Status ?? "Active")
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="user-info-label">Roles</div>
                                        <div class="user-info-value">
                                            @if (user.Roles != null && user.Roles.Any())
                                            {
                                                @foreach (var role in user.Roles)
                                                {
                                                    <span class="badge bg-primary role-badge">@role.RoleName</span>
                                                }
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary role-badge">User</span>
                                            }
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="user-info-label">Subscription Status</div>
                                        <div class="user-info-value">
                                            @{
                                                var activeSubscription = user.Subscriptions?
                                                .FirstOrDefault(s => s.Status == "Active" && s.EndDate >= DateTime.Now);
                                            }
                                            @if (activeSubscription != null)
                                            {
                                                <span class="badge bg-success subscription-badge">
                                                    Active until @(activeSubscription.EndDate?.ToString("MM/dd/yyyy") ?? "")
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary subscription-badge">No Active Subscription</span>
                                            }
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="user-info-label">Songs Uploaded</div>
                                        <div class="user-info-value">
                                            <span class="songs-count">@(user.Songs?.Count ?? 0)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-2 text-end">
                                <div class="d-flex flex-column">
                                    @if (user.Status == "Active")
                                    {
                                        <button class="action-btn ban-btn status-change-btn" data-id="@user.UserId" data-status="Banned" data-name="@user.UserName">
                                            <i class="fa fa-ban me-1"></i>Ban
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="action-btn activate-btn status-change-btn" data-id="@user.UserId" data-status="Active" data-name="@user.UserName">
                                            <i class="fa fa-check me-1"></i>Activate
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="alert alert-info text-center">
                    <i class="fa fa-info-circle me-2"></i>
                    No users found in the system.
                </div>
            }
        </div>
    </div>
</div>

<!-- Status Change Confirmation Modal -->
<div class="modal fade" id="confirmStatusChangeModal" tabindex="-1" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Change User Status?</h5>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to change the status of user <strong id="statusChangeUserName"></strong> to <strong id="statusChangeNewStatus"></strong>?</p>
                <div class="alert alert-warning" id="statusChangeWarning" style="display: none;">
                    <strong>Warning:</strong> <span id="statusChangeWarningText"></span>
                </div>
                <p class="message text-danger"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelStatusChangeBtn">Cancel</button>
                <button type="button" class="btn btn-primary" id="modalStatusChangeConfirm">Change Status</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            var UserId = null;
            var UserName = '';
            var NewStatus = '';

            // Status change handling
            $(document).on('click', '.status-change-btn', function() {
                UserId = $(this).data('id');
                UserName = $(this).data('name');
                NewStatus = $(this).data('status');

                $('#statusChangeUserName').text(UserName);
                $('#statusChangeNewStatus').text(NewStatus);

                // Show appropriate warning
                var warningText = '';
                if (NewStatus === 'Banned') {
                    warningText = 'Banned users cannot log in to the system and are hidden from most views.';
                    $('#statusChangeWarning').show();
                } else {
                    $('#statusChangeWarning').hide();
                }
                $('#statusChangeWarningText').text(warningText);

                $('.message').text('');
                $('#confirmStatusChangeModal').modal('show');
            });

            // Cancel status change
            $(document).on('click', '#cancelStatusChangeBtn', function() {
                $('#confirmStatusChangeModal').modal('hide');
                UserId = null;
                UserName = '';
                NewStatus = '';
                $('.message').text('');
            });

            // Confirm status change
            $("#modalStatusChangeConfirm").on('click', function() {
                if (!UserId || !NewStatus) return;

                $(this).prop('disabled', true).text('Changing...');

                $.ajax({
                    url: '/Admin/UpdateUserStatus',
                    type: 'POST',
                    data: { userId: UserId, status: NewStatus },
                    success: function(response) {
                        if (response.success) {
                            $('#confirmStatusChangeModal').modal('hide');
                            alert(response.message);
                            location.reload();
                        } else {
                            $('.message').text('Error: ' + (response.message || 'Unknown error'));
                            $("#modalStatusChangeConfirm").prop('disabled', false).text('Change Status');
                        }
                    },
                    error: function() {
                        $('.message').text('An error occurred while changing user status.');
                        $("#modalStatusChangeConfirm").prop('disabled', false).text('Change Status');
                    }
                });
            });

            // ID-based status change functionality
            function handleStatusChangeById(targetStatus) {
                var userId = $('#userIdInput').val();

                if (!userId || userId.trim() === '') {
                    alert('Please enter a valid User ID');
                    return;
                }

                UserId = parseInt(userId);
                UserName = 'User ID: ' + userId; // Generic name
                NewStatus = targetStatus;

                $('#statusChangeUserName').text(UserName);
                $('#statusChangeNewStatus').text(NewStatus);

                // Show appropriate warning
                var warningText = '';
                if (NewStatus === 'Banned') {
                    warningText = 'Banned users cannot log in to the system and are hidden from most views.';
                    $('#statusChangeWarning').show();
                } else {
                    $('#statusChangeWarning').hide();
                }
                $('#statusChangeWarningText').text(warningText);

                $('.message').text('');
                $('#confirmStatusChangeModal').modal('show');

                // Clear the input
                $('#userIdInput').val('');
            }

            // Ban by ID button
            $('#banByIdBtn').on('click', function() {
                handleStatusChangeById('Banned');
            });

            // Activate by ID button
            $('#activateByIdBtn').on('click', function() {
                handleStatusChangeById('Active');
            });

            // Allow Enter key to trigger status change (default to Ban)
            $('#userIdInput').on('keypress', function(e) {
                if (e.which === 13) { // Enter key
                    handleStatusChangeById('Banned');
                }
            });
        });
    </script>
}