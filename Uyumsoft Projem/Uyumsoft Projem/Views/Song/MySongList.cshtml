@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    var songs = ViewBag.MySongList as IEnumerable<Uyumsoft_Projem.Models.Song>;
    var requests = ViewBag.Requests as IEnumerable<Uyumsoft_Projem.ViewModels.SongSingerRequestViewModel>;
}

<section class="songs-section" style="background: #fff;">
    <div class="container py-5">

        @* ——— İstekler Bölümü ——— *@
        @if (requests != null && requests.Any())
        {
            <div class="mb-4">
                <partial name="_SingerRequestsPartial" model="requests" />
            </div>
        }

        <!-- Trigger button -->
        <div class="text-right mb-4">
            <button class="btn btn-success add-btn">
                Add New Song
            </button>
        </div>
        <div class="section-title mb-4">
            <h2 style="color:#222;">My Songs</h2>
        </div>
        <div class="row">
            @foreach (var song in songs)
            {
                <div class="col-md-4 mb-4">
                    <div class="song-item p-3" style="background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                        <div class="song-info-box">
                            <img src="@song.ImagePath" alt="" style="width:100%; border-radius:6px; margin-bottom:10px;">
                            <div class="song-info mt-2" style="position:relative; background:#f9f9f9; padding:10px; border-radius:6px;">
                                <p style="color:#444;">@song.Title</p>
                                <span class="text-muted" style="color:#888;">Price: $@song.Price</span>
                            </div>
                        </div>
                        <div class="songs-links mt-3">
                            <button class="btn btn-sm btn-info details-btn" data-id="@song.SongId">Details</button>
                            <button class="btn btn-sm btn-warning update-btn" data-id="@song.SongId">Update</button>
                            <button class="btn btn-sm btn-danger delete-btn" data-id="@song.SongId">Delete</button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Delete Song?</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this song permanently?
                </div>
                <p class="message text-danger"></p>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="modalDeleteConfirm">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal fade" id="modalSongForm" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Song</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="songFormContainer">
                    <!-- Partial View Here -->
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        $(function () {
            $('.modal-open').on('click', function (event) {
                var reqId = $(this).attr('data-request-id');
                var title = $(this).data('title');
                var senderName = $(this).data('sender');

                var modal = $('#requestModal');
                modal.find('#modalBodyText').text(senderName + ' wants to add you to "' + title + '" as a Co-Artist.');
                console.log("Modal opened.");
                modal.data('request-id', reqId);

                modal.modal('show');
            });

            $('#acceptRequestBtn').on('click', function () {
            var reqId = $('#requestModal').data('request-id');
            $.ajax({
                url: '/Song/AcceptRequest',
                type: 'POST',
                data: { id: reqId },
                success: function () {
                    $('#requestModal').modal('hide');
                    location.reload();
                },
                error: function () {
                    alert('Bir hata oluştu. Lütfen tekrar deneyin.');
                }
            });
        });

        $('#rejectRequestBtn').on('click', function () {
            var reqId = $('#requestModal').data('request-id');
            $.ajax({
                url: '/Song/RejectRequest',
                type: 'POST',
                data: { id: reqId },
                success: function () {
                    $('#requestModal').modal('hide');
                    location.reload();
                },
                error: function () {
                    alert('Bir hata oluştu. Lütfen tekrar deneyin.');
                }
            });
        });
        });
    </script>
    <script>

        $(function () {
            var SongId = null;
                    $(".details-btn").on("click", function() {
                        var SongId = $(this).data("id");
                        window.location.href = '/Song/SongDetails?id=' + SongId;
                    });

            // Silme
            $(".delete-btn").on('click', function() {
                SongId = $(this).data('id');
                $('.message').text('');
                $('#confirmDeleteModal').modal('show');
            });

            $("#modalDeleteConfirm").on('click', function() {
                if (!SongId) return;
                $.ajax({
                    url: '/Song/DeleteSong',
                    type: 'POST',
                    data: { id: SongId },
                    success: function() {
                        $('#confirmDeleteModal').modal('hide');
                        location.reload();
                    },
                    error: function() {
                        $('.message').text('An error occurred. Please try again.');
                    }
                });
            });

            // Ekleme
            $(".add-btn").on('click', function() {
                $.get('/Song/GetSongForm', function(html) {
                    $("#songFormContainer").html(html);
                    $("#modalSongForm").modal('show');
                    bindSongForm();
                });
            });

            // Güncelleme
            $(".update-btn").on('click', function() {
                SongId = $(this).data('id');
                $.get('/Song/GetSongForm', { id: SongId }, function(html) {
                    $("#songFormContainer").html(html);
                    $("#modalSongForm").modal('show');
                    bindSongForm();
                });
            });

            function bindSongForm() {
                var $form = $("#songFormContainer").find("form");

                $form.off('submit').on('submit', function(e) {
                    e.preventDefault();
                    var formData = new FormData(this);

                    $.ajax({
                        url: $form.attr('action'),
                        method: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function() {
                            $("#modalSongForm").modal('hide');
                            location.reload();
                        },
                        error: function() {
                            $form.find('.form-error').text('An error occurred.');
                        }
                    });
                });
            }
        });
    </script>
    <script>
        $('#songFormContainer form').on('submit', function(e){
          var val = $('#songArtistInput').val().trim();

          var re = /^([^\s,]+)(,[^\s,]+)*$/;
          if (val && !re.test(val)) {
            e.preventDefault();
            $('#artistError').removeClass('d-none');
          } else {
            $('#artistError').addClass('d-none');
          }
        });

    </script>
}
